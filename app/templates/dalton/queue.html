{% extends "dalton/layout.html" %}
{% block body %}
    <div class="row">
        <div class="span11">
            <h2>Recent Jobs</h2>
            <h4 id="queue-summary">Queued Jobs: <span id="queued-count">{{ queued_jobs }}</span>&nbsp;&nbsp;|&nbsp;&nbsp;Running Jobs: <span id="running-count">{{ running_jobs }}</span></h4>
            <h5>Show Recent:
            &nbsp;
            <span id="num-jobs-selector"></span>
            <span id="queue-last-updated" class="text-muted" style="font-size: 0.85em; margin-left: 15px;"></span>
            </h5>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Job ID</th>
                        <th id="user-column-header" {% if non_empty_user_count == 0 %}style="display: none;"{% endif %}>User</th>
                        <th>Alert Count</th>
                        <th>Queue</th>
                        <th>Submission Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="queue-table-body">
                {% for job in queue %}
			<tr>
				<td><a href="/dalton/job/{{job.jid}}">{{ job.jid }}</a></td>
                <td class="user-column" {% if non_empty_user_count == 0 %}style="display: none;"{% endif %}>{{ job.user }}</td>
				<td>
                    {% if job.alert_count is number %}
                        {{ job.alert_count|int }}
                    {% else %}
                        {{ job.alert_count }}
                    {% endif %}
                </td>
				<td>
                {% set tlist = job.tech.split('/') %}
                {% if tlist|length > 1 %}
                    {% if tlist[1].startswith("rust_") %}
                        {{tlist[0]|title}} {{tlist[1][5:]}} ({% if tlist|length > 2 %}{{tlist[2]}} - {% endif %}with Rust support)
                    {% else %}
                        {{tlist[0]|title}} {{tlist[1]}}{% if tlist|length > 2 %} ({{tlist[2]}}){% endif %}
                    {% endif %}
                {% else %}
                    {{job.tech|title}}
                {% endif %}
			    </td>
				<td>{{ job.time }}</td>
				<td class="{% if 'Success' in job.status %}status-success{% elif 'Error' in job.status %}status-error{% elif job.status == 'Running' %}status-running{% elif job.status == 'Timeout' %}status-timeout{% elif job.status == 'Interrupted' %}status-interrupted{% else %}status-queued{% endif %}">{{ job.status }}</td>
			</tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div><!--/row-->

    <script type="text/javascript">
    (function() {
        var POLL_INTERVAL = 3000; // 3 seconds
        var showOptions = [25, 50, 100, 200, 300, 500, 1000];
        var currentNumJobs = {{ num_jobs }};
        var previousJobStates = {};  // { jid: status }
        var tracker = DaltonUtils.createLastUpdatedTracker('queue-last-updated');

        function getStatusClass(status) {
            if (status.indexOf('Success') !== -1) return 'status-success';
            if (status.indexOf('Error') !== -1) return 'status-error';
            if (status === 'Running') return 'status-running';
            if (status === 'Timeout') return 'status-timeout';
            if (status === 'Interrupted') return 'status-interrupted';
            return 'status-queued';
        }

        function formatAlertCount(alertCount) {
            if (typeof alertCount === 'number') {
                return Math.floor(alertCount).toString();
            }
            return DaltonUtils.escapeHtml(alertCount);
        }

        function renderNumJobsSelector() {
            var container = document.getElementById('num-jobs-selector');
            if (!container) return;

            var html = [];
            for (var i = 0; i < showOptions.length; i++) {
                if (i !== 0) {
                    html.push('&nbsp;|&nbsp;');
                }
                if (showOptions[i] === currentNumJobs) {
                    html.push(showOptions[i]);
                } else {
                    html.push('<a href="#" class="num-jobs-link" data-num="' + showOptions[i] + '">' + showOptions[i] + '</a>');
                }
            }
            container.innerHTML = html.join('');

            // Bind click handlers
            var links = container.querySelectorAll('.num-jobs-link');
            for (var j = 0; j < links.length; j++) {
                links[j].addEventListener('click', function(e) {
                    e.preventDefault();
                    var num = parseInt(this.getAttribute('data-num'), 10);
                    currentNumJobs = num;
                    renderNumJobsSelector();
                    pollQueue(); // Immediate refresh
                    // Update URL without reload
                    if (window.history && window.history.replaceState) {
                        window.history.replaceState({}, '', 'queue?numjobs=' + num);
                    }
                });
            }
        }

        function updateUserColumnVisibility(hasUsers) {
            var header = document.getElementById('user-column-header');
            var cells = document.querySelectorAll('.user-column');

            if (header) {
                header.style.display = hasUsers ? '' : 'none';
            }
            for (var i = 0; i < cells.length; i++) {
                cells[i].style.display = hasUsers ? '' : 'none';
            }
        }

        function rebuildQueueTable(jobs, hasUsers) {
            var tbody = document.getElementById('queue-table-body');
            if (!tbody) return;

            var newJobStates = {};
            var rows = [];
            for (var i = 0; i < jobs.length; i++) {
                var job = jobs[i];
                var userCell = '<td class="user-column"' + (hasUsers ? '' : ' style="display: none;"') + '>' + DaltonUtils.escapeHtml(job.user) + '</td>';

                // Determine status class and whether status changed
                var statusClass = getStatusClass(job.status);
                var statusChanged = previousJobStates[job.jid] !== undefined && previousJobStates[job.jid] !== job.status;
                var highlightClass = statusChanged ? ' status-highlight' : '';
                newJobStates[job.jid] = job.status;

                var row = '<tr>' +
                    '<td><a href="/dalton/job/' + DaltonUtils.escapeHtml(job.jid) + '">' + DaltonUtils.escapeHtml(job.jid) + '</a></td>' +
                    userCell +
                    '<td>' + formatAlertCount(job.alert_count) + '</td>' +
                    '<td>' + DaltonUtils.escapeHtml(DaltonUtils.formatTechnology(job.tech)) + '</td>' +
                    '<td>' + DaltonUtils.escapeHtml(job.time) + '</td>' +
                    '<td class="' + statusClass + highlightClass + '">' + DaltonUtils.escapeHtml(job.status) + '</td>' +
                    '</tr>';
                rows.push(row);
            }

            // Update previous states for next comparison
            previousJobStates = newJobStates;

            if (rows.length === 0) {
                var colspan = hasUsers ? 6 : 5;
                tbody.innerHTML = '<tr><td colspan="' + colspan + '" class="text-center">No recent jobs</td></tr>';
            } else {
                tbody.innerHTML = rows.join('');
            }
        }

        function updateSummary(summary) {
            var queuedEl = document.getElementById('queued-count');
            var runningEl = document.getElementById('running-count');

            if (queuedEl) queuedEl.textContent = summary.queued_jobs;
            if (runningEl) runningEl.textContent = summary.running_jobs;
        }

        function pollQueue() {
            $.ajax({
                url: '/dalton/controller_api/get-queue-json?num_jobs=' + currentNumJobs,
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    updateSummary(data.summary);
                    updateUserColumnVisibility(data.has_users);
                    rebuildQueueTable(data.jobs, data.has_users);
                    tracker.markUpdated();
                },
                error: function(xhr, status, error) {
                    console.error('Failed to fetch queue:', error);
                    // Don't clear table on error - keep stale data visible
                }
            });
        }

        // Initialize previous job states from server-rendered data
        {% for job in queue %}
        previousJobStates['{{ job.jid }}'] = '{{ job.status }}';
        {% endfor %}

        // Initialize
        renderNumJobsSelector();
        DaltonUtils.createPoller(pollQueue, POLL_INTERVAL).start();
    })();
    </script>
{% endblock %}
